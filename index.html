<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Roleta de Pr√™mios</title>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; background: #f4f4f4; }
    h1 { margin-top: 20px; }
    input, button { margin: 10px; padding: 10px; font-size: 16px; }
    #resultado { font-weight: bold; margin-top: 20px; font-size: 18px; color: #333; }
    canvas { margin-top: 20px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    .pointer { width: 0; height: 0; margin: 20px auto; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid red; }
  </style>
</head>
<body>
  <h1>üéÅ Roleta de Pr√™mios</h1>
  <input id="nick" placeholder="Digite seu nick">
  <br>
  <button onclick="girar()">Girar!</button>
  <div class="pointer"></div>
  <canvas id="roleta" width="400" height="400"></canvas>
  <p id="resultado"></p>

  <!-- Sons -->
  <audio id="somRoleta" src="https://actions.google.com/sounds/v1/alarms/cycle_alarm.ogg" preload="auto"></audio>
  <audio id="somVitoria" src="https://actions.google.com/sounds/v1/crowds/cheer.ogg" preload="auto"></audio>

  <script>
    // === SUA API DO GOOGLE APPS SCRIPT ===
    const API_URL = "https://script.google.com/macros/s/AKfycbz_qOsdx0avjQZ0Hg6ktnTeYknYAb3x-nmdnHvwVZ0K0KVZSk6QSxuQkMoi2KdPX8wNuQ/exec";

    // === CONFIGURA√á√ÉO DOS PR√äMIOS ===
    const premios = [
      { nome: "Skin rara", chance: 50, cor: "#FFD700" },
      { nome: "100 moedas", chance: 30, cor: "#87CEEB" },
      { nome: "Nada üò¢", chance: 20, cor: "#FF6347" }
    ];

    const canvas = document.getElementById("roleta");
    const ctx = canvas.getContext("2d");
    const radius = canvas.width / 2;

    let angulos = []; 
    let girando = false;

    const somRoleta = document.getElementById("somRoleta");
    const somVitoria = document.getElementById("somVitoria");

    // Desenhar a roleta (fatias iguais)
    function desenharRoleta() {
      let anguloInicial = 0;
      let fatia = (2 * Math.PI) / premios.length;
      angulos = [];

      premios.forEach(p => {
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, anguloInicial, anguloInicial + fatia);
        ctx.fillStyle = p.cor;
        ctx.fill();

        // Texto
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(anguloInicial + fatia / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "16px Arial";
        ctx.fillText(p.nome, radius - 10, 5);
        ctx.restore();

        angulos.push({ premio: p.nome, inicio: anguloInicial, fim: anguloInicial + fatia });
        anguloInicial += fatia;
      });
    }

    desenharRoleta();

    // Sorteio REAL baseado na chance
    function sortearPremio() {
      const total = premios.reduce((acc, p) => acc + p.chance, 0);
      let r = Math.random() * total;
      let acumulado = 0;
      for (const p of premios) {
        acumulado += p.chance;
        if (r <= acumulado) return p.nome;
      }
    }

    // Girar a roleta (tempo fixo: 10s)
    function girar() {
      if (girando) return;
      const nick = document.getElementById("nick").value.trim();
      if (!nick) { alert("Digite seu nick!"); return; }

      girando = true;
      const premio = sortearPremio();

      // Encontrar √¢ngulo alvo
      const alvo = angulos.find(a => a.premio === premio);
      const meio = (alvo.inicio + alvo.fim) / 2;

      // Adiciona voltas extras
      const voltas = 10 * 2 * Math.PI;
      // Corrigido: garante que o pr√™mio pare alinhado com a seta vermelha
      const anguloFinal = voltas - (Math.PI / 2 - meio);

      let anguloAtual = 0;
      const duracao = 10000; // 10 segundos
      const inicio = performance.now();
      let ultimoTick = 0;

      function animar(tempo) {
        const progresso = (tempo - inicio) / duracao;
        if (progresso < 1) {
          const easeOut = 1 - Math.pow(1 - progresso, 3); // desacelera√ß√£o suave
          anguloAtual = anguloFinal * easeOut;

          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.save();
          ctx.translate(radius, radius);
          ctx.rotate(anguloAtual);
          ctx.translate(-radius, -radius);
          desenharRoleta();
          ctx.restore();

          // Efeito sonoro de "tic tic"
          if (tempo - ultimoTick > 150) { 
            somRoleta.currentTime = 0;
            somRoleta.play();
            ultimoTick = tempo;
          }

          requestAnimationFrame(animar);
        } else {
          girando = false;
          document.getElementById("resultado").innerText = `${nick} ganhou: ${premio}`;

          // Som de vit√≥ria
          somVitoria.play();

          // Enviar para Google Sheets
          fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ nick, premio }).toString()
          });
        }
      }

      requestAnimationFrame(animar);
    }
  </script>
</body>
</html>
