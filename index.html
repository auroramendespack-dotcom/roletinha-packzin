<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Roleta de Pr√™mios</title>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; background: #f4f4f4; }
    h1 { margin-top: 20px; }
    input, button { margin: 10px; padding: 10px; font-size: 16px; }
    #resultado { font-weight: bold; margin-top: 20px; font-size: 18px; color: #333; }
    canvas { margin-top: 20px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    .pointer {
      width: 0; height: 0; margin: 20px auto;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 40px solid red; /* seta apontando para baixo (topo da roleta) */
    }
  </style>
</head>
<body>
  <h1>üéÅ Roleta de Pr√™mios</h1>
  <input id="nick" placeholder="Digite seu nick">
  <br>
  <button onclick="girar()">Girar!</button>
  <div class="pointer"></div>
  <canvas id="roleta" width="400" height="400"></canvas>
  <p id="resultado"></p>

  <!-- Sons (pode trocar os URLs se quiser outros efeitos) -->
  <audio id="somTick" src="https://actions.google.com/sounds/v1/impacts/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="somVitoria" src="https://actions.google.com/sounds/v1/crowds/cheer.ogg" preload="auto"></audio>

  <script>
    // === SUA API DO GOOGLE APPS SCRIPT ===
    const API_URL = "https://script.google.com/macros/s/AKfycbz_qOsdx0avjQZ0Hg6ktnTeYknYAb3x-nmdnHvwVZ0K0KVZSk6QSxuQkMoi2KdPX8wNuQ/exec";

    // === CONFIGURA√á√ÉO DOS PR√äMIOS ===
    // Deixe os "chances" reais aqui. Visualmente, as fatias s√£o sempre iguais.
    const premios = [
      { nome: "Skin rara",  chance: 50, cor: "#FFD700" },
      { nome: "100 moedas", chance: 30, cor: "#87CEEB" },
      { nome: "Nada üò¢",    chance: 20, cor: "#FF6347" }
    ];

    const canvas = document.getElementById("roleta");
    const ctx = canvas.getContext("2d");
    const radius = canvas.width / 2;

    const somTick = document.getElementById("somTick");
    const somVitoria = document.getElementById("somVitoria");

    let fatiaAng = (2 * Math.PI) / premios.length;
    let setores = [];       // { premio, inicio, fim }
    let girando = false;

    // Desenha a roleta (fatias iguais)
    function desenharRoleta() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      setores = [];

      let inicio = 0;
      for (const p of premios) {
        const fim = inicio + fatiaAng;

        // fatia
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, inicio, fim);
        ctx.fillStyle = p.cor;
        ctx.fill();

        // texto
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(inicio + fatiaAng / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "16px Arial";
        ctx.fillText(p.nome, radius - 10, 5);
        ctx.restore();

        setores.push({ premio: p.nome, inicio, fim });
        inicio = fim;
      }
    }

    desenharRoleta(); // desenho inicial sem rota√ß√£o

    // Sorteio REAL baseado nas chances
    function sortearPremio() {
      const total = premios.reduce((s, p) => s + p.chance, 0);
      let r = Math.random() * total;
      let acumulado = 0;
      for (const p of premios) {
        acumulado += p.chance;
        if (r <= acumulado) return p.nome;
      }
    }

    // Normaliza um √¢ngulo para [0, 2œÄ)
    function normalizarAng(a) {
      const doisPi = 2 * Math.PI;
      a = a % doisPi;
      if (a < 0) a += doisPi;
      return a;
    }

    // Anima√ß√£o de giro (fixo: 10s) e alinhamento no topo (seta)
    function girar() {
      if (girando) return;
      const nick = document.getElementById("nick").value.trim();
      if (!nick) { alert("Digite seu nick!"); return; }

      girando = true;

      // Pr√™mio sorteado (probabilidade real)
      const premio = sortearPremio();

      // Centro angular da fatia do pr√™mio
      const alvo = setores.find(s => s.premio === premio);
      const meio = (alvo.inicio + alvo.fim) / 2;

      // Queremos que "meio" chegue ao topo (3œÄ/2 rad)
      const offsetTopo = normalizarAng(3 * Math.PI / 2 - meio);

      // V√°rias voltas + offset at√© a seta
      const voltas = 10 * 2 * Math.PI;   // 10 voltas completas
      const anguloFinal = voltas + offsetTopo;

      // Anima√ß√£o (10s com ease out c√∫bico)
      const inicio = performance.now();
      const duracao = 10000;
      let passosTick = -1; // para tocar o "tic" quando cruzar bordas

      function frame(t) {
        const progresso = Math.min(1, (t - inicio) / duracao);
        const easeOut = 1 - Math.pow(1 - progresso, 3);
        const anguloAtual = anguloFinal * easeOut;

        // desenha roleta j√° rotacionada
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(anguloAtual); // rota√ß√£o positiva = sentido hor√°rio
        ctx.translate(-radius, -radius);
        desenharRoleta();
        ctx.restore();

        // toca "tic" a cada borda de fatia que passa sob a seta
        const passoAtual = Math.floor(anguloAtual / fatiaAng);
        if (passoAtual !== passosTick) {
          try { somTick.currentTime = 0; somTick.play(); } catch (e) {}
          passosTick = passoAtual;
        }

        if (progresso < 1) {
          requestAnimationFrame(frame);
        } else {
          girando = false;

          // resultado final
          document.getElementById("resultado").innerText = `${nick} ganhou: ${premio}`;

          // som de comemora√ß√£o
          try { somVitoria.currentTime = 0; somVitoria.play(); } catch (e) {}

          // envia para planilha
          fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ nick, premio }).toString()
          });
        }
      }

      requestAnimationFrame(frame);
    }
  </script>
</body>
</html>
